<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<title>Coq typeclass resolution is Turing-complete</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<div class="code">
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">List</span>. <span class="id" title="keyword">Import</span> <span class="id" title="var">ListNotations</span>.<br/>

<br/>
</div>

<div class="doc">
<a id="lab1"></a><h1 class="section">Coq typeclass resolution is Turing-complete</h1>


<div class="paragraph"> </div>

    by Thalia Archibald, 15 Apr 2023

<div class="paragraph"> </div>

    The Coq theorem prover has a powerful means of abstraction, typeclasses. To
    resolve a typeclass instance, the typechecker performs an unrestricted
    search for an instance satisfying those constraints. The steps in this
    search resemble the trace of a program execution, and, crucially, it is
    possible to express unsatisfiable constraints, which cause an infinite
    search. This indicates it should be Turing-complete! Let's prove it!
<div class="paragraph"> </div>

<a id="lab2"></a><h2 class="section">Background on typeclasses</h2>


<div class="paragraph"> </div>

    A typeclass is essentially an interface associated with a type.

<div class="paragraph"> </div>

    Typeclasses were first introduced in Haskell and have since been adopted by
    many other languages, including in Rust as traits. With its richer dependent
    types, Coq further extends typeclasses to allow for values in constraints.
    This allows for computation to be mixed with the search for an instance.

<div class="paragraph"> </div>

    For a more in-depth tutorial on typeclasses, see the
    <a href="https://softwarefoundations.cis.upenn.edu/qc-current/Typeclasses.html">
    Typeclasses</a> chapter in the fantastic Software Foundations series. The
    section on non-termination and the advice from experts are particularly
    relevant to this.
<div class="paragraph"> </div>

<a id="lab3"></a><h2 class="section">Smallfuck</h2>


<div class="paragraph"> </div>

    To prove Turing-completeness, it is sufficient to implement a
    Turing-complete language.

<div class="paragraph"> </div>

    I model the semantics of <a href="https://esolangs.org/wiki/Smallfuck">
    Smallfuck</a>, a subset of Brainfuck, using typeclass instances. Smallfuck
    has a tape of bits and can move the cell pointer left or right, flip the
    current cell, and loop. I/O and a more complex cell type are not needed to
    demonstrate Turing-completeness, but you could see how that would be
    modelled in my <a href="https://github.com/thaliaarchi/bfcoq">bfcoq</a>
    project.
<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">prog</span></span> represents a Smallfuck program:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">PRight</span></span> (<span class="inlinecode">&gt;</span>) moves the tape right

</li>
<li> <span class="inlinecode"><span class="id" title="var">PLeft</span></span> (<span class="inlinecode">&lt;</span>) moves the tape left

</li>
<li> <span class="inlinecode"><span class="id" title="var">PFlip</span></span> (<span class="inlinecode">*</span>) flips the current cell

</li>
<li> <span class="inlinecode"><span class="id" title="var">PLoop</span></span> (<span class="inlinecode">[…]</span>) repeats while the current cell is 1

</li>
<li> <span class="inlinecode"><span class="id" title="var">PEnd</span></span> is a no-op used at the end of a loop or program

</li>
</ul>
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">prog</span> : <span class="id" title="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">PRight</span> (<span class="id" title="var">next</span> : <span class="id" title="var">prog</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">PLeft</span> (<span class="id" title="var">next</span> : <span class="id" title="var">prog</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">PFlip</span> (<span class="id" title="var">next</span> : <span class="id" title="var">prog</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">PLoop</span> (<span class="id" title="var">body</span> <span class="id" title="var">next</span> : <span class="id" title="var">prog</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">PEnd</span>.<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">tape</span></span> is an infinite tape, where <span class="inlinecode"><span class="id" title="var">cell</span></span> is the current cell and <span class="inlinecode"><span class="id" title="var">ltape</span></span> and
    <span class="inlinecode"><span class="id" title="var">rtape</span></span> are the cells to the left and right, respectively.
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Record</span> <span class="id" title="var">tape</span> : <span class="id" title="keyword">Type</span> := <span class="id" title="var">Tape</span> {<br/>
&nbsp;&nbsp;<span class="id" title="var">cell</span> : <span class="id" title="var">bool</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">ltape</span> : <span class="id" title="var">list</span> <span class="id" title="var">bool</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">rtape</span> : <span class="id" title="var">list</span> <span class="id" title="var">bool</span>;<br/>
}.<br/>

<br/>
</div>

<div class="doc">
Let's define a shorthand for booleans.
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Local</span> <span class="id" title="keyword">Notation</span> "0" := <span class="id" title="var">false</span>.<br/>
<span class="id" title="keyword">Local</span> <span class="id" title="keyword">Notation</span> "1" := <span class="id" title="var">true</span>.<br/>

<br/>
</div>

<div class="doc">
<a id="lab4"></a><h2 class="section">Big-step semantics</h2>


<div class="paragraph"> </div>

    To execute a Smallfuck program, we map an initial tape to a final tape. I
    model this as a typeclass <span class="inlinecode"><span class="id" title="var">Exec</span></span>, that takes a program <span class="inlinecode"><span class="id" title="var">p</span></span> and initial and
    final tapes <span class="inlinecode"><span class="id" title="var">t</span></span> and <span class="inlinecode"><span class="id" title="var">t'</span></span>. It has a function <span class="inlinecode"><span class="id" title="var">exec</span></span> that returns <span class="inlinecode"><span class="id" title="var">t'</span></span>, so it
    can be used.

<div class="paragraph"> </div>

    Notice that it is parameterized over <i>values</i> <span class="inlinecode"><span class="id" title="var">p</span></span>, <span class="inlinecode"><span class="id" title="var">t</span></span>, and <span class="inlinecode"><span class="id" title="var">t'</span></span>, not types.
    Other languages only allow types as generic parameters, but Coq generalizes
    it to any dependently-typed term, values and types.
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Class</span> <span class="id" title="var">Exec</span> (<span class="id" title="var">p</span> : <span class="id" title="var">prog</span>) (<span class="id" title="var">t</span> <span class="id" title="var">t'</span> : <span class="id" title="var">tape</span>) : <span class="id" title="keyword">Type</span> := {<br/>
&nbsp;&nbsp;<span class="id" title="var">exec</span> := <span class="id" title="var">t'</span>;<br/>
}.<br/>

<br/>
</div>

<div class="doc">
I then define instances of <span class="inlinecode"><span class="id" title="var">Exec</span></span> for each operation in big-step semantics
    style. These define the transformations to be performed in each case, and
    can be seen as a pattern matching at the instance level.

<div class="paragraph"> </div>

    <span class="inlinecode"><span class="id" title="var">PEnd</span></span> is the simplest to model; it takes a tape <span class="inlinecode"><span class="id" title="var">t</span></span> and maps it to
    itself (does nothing). Syntactically, this defines an instance named
    <span class="inlinecode"><span class="id" title="var">Exec_End</span></span>, that satisfies <span class="inlinecode"><span class="id" title="var">Exec</span></span> for the program <span class="inlinecode"><span class="id" title="var">PEnd</span></span> and some tape <span class="inlinecode"><span class="id" title="var">t</span></span>
    for both the initial and final tape.
</div>
<div class="code">

<br/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">Exec_End</span> <span class="id" title="var">t</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">Exec</span> <span class="id" title="var">PEnd</span> <span class="id" title="var">t</span> <span class="id" title="var">t</span> := {}.<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">PFlip</span></span> negates the current cell.

<div class="paragraph"> </div>

    Intuitively, this definition states that if the remainder of the program can
    be executed, then we can also execute <span class="inlinecode"><span class="id" title="var">PFlip</span></span>. That is, if it can resolve an
    instance for the program starting after applying the flip, then it will
    supply an instance for the flip. This order is backwards, because it applies
    the operations post-order in a depth-first search.

<div class="paragraph"> </div>

    The parameter <span class="inlinecode">`{<span class="id" title="var">Exec</span></span> <span class="inlinecode"><span class="id" title="var">p</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">t'</span>}</span> is a class constraint, which implicitly
    supplies evidence that <span class="inlinecode"><span class="id" title="var">p</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">t'</span></span> has an instance of <span class="inlinecode"><span class="id" title="var">Exec</span></span>. It is equivalent
    to <span class="inlinecode">{<span class="id" title="var">E</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">Exec</span></span> <span class="inlinecode"><span class="id" title="var">p</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">t'</span>}</span>, but where the name is not used.
</div>
<div class="code">

<br/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">Exec_Flip</span> <span class="id" title="var">p</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">Exec</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> (<span class="id" title="var">negb</span> <span class="id" title="var">c</span>) <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span>} :<br/>
&nbsp;&nbsp;<span class="id" title="var">Exec</span> (<span class="id" title="var">PFlip</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span> := {}.<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">PRight</span></span> has two cases: When the tape has at least one cell to the left,
    shift that cell to the current and the old current to the right. When the
    left tape is empty, use <span class="inlinecode">0</span> as the new current cell.

<div class="paragraph"> </div>

    Here, we destructure <span class="inlinecode"><span class="id" title="var">Tape</span></span>, so we can cover the cases of <span class="inlinecode">[]</span> and
    <span class="inlinecode"><span class="id" title="var">_</span></span> <span class="inlinecode">::</span> <span class="inlinecode"><span class="id" title="var">_</span></span>.
</div>
<div class="code">

<br/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">Exec_Right_cons</span> <span class="id" title="var">p</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> <span class="id" title="var">rc</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">Exec</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> <span class="id" title="var">rc</span> (<span class="id" title="var">c</span> :: <span class="id" title="var">lt</span>) <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span>} :<br/>
&nbsp;&nbsp;<span class="id" title="var">Exec</span> (<span class="id" title="var">PRight</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> (<span class="id" title="var">rc</span> :: <span class="id" title="var">rt</span>)) <span class="id" title="var">t'</span> := {}.<br/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">Exec_Right_nil</span> <span class="id" title="var">p</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">Exec</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> 0 (<span class="id" title="var">c</span> :: <span class="id" title="var">lt</span>) []) <span class="id" title="var">t'</span>} :<br/>
&nbsp;&nbsp;<span class="id" title="var">Exec</span> (<span class="id" title="var">PRight</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> []) <span class="id" title="var">t'</span> := {}.<br/>

<br/>
</div>

<div class="doc">
Likewise for <span class="inlinecode"><span class="id" title="var">PLeft</span></span>.
</div>
<div class="code">

<br/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">Exec_Left_cons</span> <span class="id" title="var">p</span> <span class="id" title="var">c</span> <span class="id" title="var">lc</span> <span class="id" title="var">lt</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">Exec</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> <span class="id" title="var">lc</span> <span class="id" title="var">lt</span> (<span class="id" title="var">c</span> :: <span class="id" title="var">rt</span>)) <span class="id" title="var">t'</span>} :<br/>
&nbsp;&nbsp;<span class="id" title="var">Exec</span> (<span class="id" title="var">PLeft</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> <span class="id" title="var">c</span> (<span class="id" title="var">lc</span> :: <span class="id" title="var">lt</span>) <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span> := {}.<br/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">Exec_Left_nil</span> <span class="id" title="var">p</span> <span class="id" title="var">c</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">Exec</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> 0 [] (<span class="id" title="var">c</span> :: <span class="id" title="var">rt</span>)) <span class="id" title="var">t'</span>} :<br/>
&nbsp;&nbsp;<span class="id" title="var">Exec</span> (<span class="id" title="var">PLeft</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> <span class="id" title="var">c</span> [] <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span> := {}.<br/>

<br/>
</div>

<div class="doc">
Finally, <span class="inlinecode"><span class="id" title="var">PLoop</span></span> has two cases: When the current cell is <span class="inlinecode">0</span>, skip the body
    and execute the next operation. When the current cell is <span class="inlinecode">1</span>, execute the
    body, then repeat the loop.

<div class="paragraph"> </div>

    <span class="inlinecode"><span class="id" title="var">Exec_Loop_1</span></span> requires two instances, for executing the body once and for
    executing the loop again.
</div>
<div class="code">

<br/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">Exec_Loop_0</span> <span class="id" title="var">b</span> <span class="id" title="var">p</span> <span class="id" title="var">lt</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">Exec</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> 0 <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span>} :<br/>
&nbsp;&nbsp;<span class="id" title="var">Exec</span> (<span class="id" title="var">PLoop</span> <span class="id" title="var">b</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> 0 <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span> := {}.<br/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">Exec_Loop_1</span> <span class="id" title="var">b</span> <span class="id" title="var">p</span> <span class="id" title="var">lt</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span> <span class="id" title="var">t''</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">Exec</span> <span class="id" title="var">b</span> (<span class="id" title="var">Tape</span> 1 <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span>}<br/>
&nbsp;&nbsp;`{<span class="id" title="var">Exec</span> (<span class="id" title="var">PLoop</span> <span class="id" title="var">b</span> <span class="id" title="var">p</span>) <span class="id" title="var">t'</span> <span class="id" title="var">t''</span>} :<br/>
&nbsp;&nbsp;<span class="id" title="var">Exec</span> (<span class="id" title="var">PLoop</span> <span class="id" title="var">b</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> 1 <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t''</span> := {}.<br/>

<br/>
</div>

<div class="doc">
For comparison, this closely resembles a typical relational definition in
    Coq, where <span class="inlinecode"><span class="id" title="var">Exec</span></span> becomes the type signature and each instance becomes a
    variant. However, a relation cannot solve for the final tape, like the next
    section shows with typeclasses.
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">exec_rel</span> : <span class="id" title="var">prog</span> → <span class="id" title="var">tape</span> → <span class="id" title="var">tape</span> → <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">ExecRel_Right_cons</span> <span class="id" title="var">p</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> <span class="id" title="var">rc</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> <span class="id" title="var">rc</span> (<span class="id" title="var">c</span> :: <span class="id" title="var">lt</span>) <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> (<span class="id" title="var">PRight</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> (<span class="id" title="var">rc</span> :: <span class="id" title="var">rt</span>)) <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">ExecRel_Right_nil</span> <span class="id" title="var">p</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> <span class="id" title="var">t'</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> 0 (<span class="id" title="var">c</span> :: <span class="id" title="var">lt</span>) []) <span class="id" title="var">t'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> (<span class="id" title="var">PRight</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> []) <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">ExecRel_Left_cons</span> <span class="id" title="var">p</span> <span class="id" title="var">c</span> <span class="id" title="var">lc</span> <span class="id" title="var">lt</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> <span class="id" title="var">lc</span> <span class="id" title="var">lt</span> (<span class="id" title="var">c</span> :: <span class="id" title="var">rt</span>)) <span class="id" title="var">t'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> (<span class="id" title="var">PLeft</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> <span class="id" title="var">c</span> (<span class="id" title="var">lc</span> :: <span class="id" title="var">lt</span>) <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">ExecRel_Left_nil</span> <span class="id" title="var">p</span> <span class="id" title="var">c</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> 0 [] (<span class="id" title="var">c</span> :: <span class="id" title="var">rt</span>)) <span class="id" title="var">t'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> (<span class="id" title="var">PLeft</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> <span class="id" title="var">c</span> [] <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">ExecRel_Flip</span> <span class="id" title="var">p</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> (<span class="id" title="var">negb</span> <span class="id" title="var">c</span>) <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> (<span class="id" title="var">PFlip</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> <span class="id" title="var">c</span> <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">ExecRel_Loop_0</span> <span class="id" title="var">b</span> <span class="id" title="var">p</span> <span class="id" title="var">lt</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> <span class="id" title="var">p</span> (<span class="id" title="var">Tape</span> 0 <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> (<span class="id" title="var">PLoop</span> <span class="id" title="var">b</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> 0 <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">ExecRel_Loop_1</span> <span class="id" title="var">b</span> <span class="id" title="var">p</span> <span class="id" title="var">lt</span> <span class="id" title="var">rt</span> <span class="id" title="var">t'</span> <span class="id" title="var">t''</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> <span class="id" title="var">b</span> (<span class="id" title="var">Tape</span> 1 <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> (<span class="id" title="var">PLoop</span> <span class="id" title="var">b</span> <span class="id" title="var">p</span>) <span class="id" title="var">t'</span> <span class="id" title="var">t''</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> (<span class="id" title="var">PLoop</span> <span class="id" title="var">b</span> <span class="id" title="var">p</span>) (<span class="id" title="var">Tape</span> 1 <span class="id" title="var">lt</span> <span class="id" title="var">rt</span>) <span class="id" title="var">t''</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">ExecRel_End</span> <span class="id" title="var">t</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">exec_rel</span> <span class="id" title="var">PEnd</span> <span class="id" title="var">t</span> <span class="id" title="var">t</span>.<br/>

<br/>
</div>

<div class="doc">
<a id="lab5"></a><h2 class="section">Execution</h2>


<div class="paragraph"> </div>

    Now let's execute programs by typechecking! First, enable typeclass
    debugging, so we can inspect the search path.
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Set</span> <span class="id" title="keyword">Typeclasses</span> <span class="id" title="keyword">Debug</span>.<br/>

<br/>
</div>

<div class="doc">
As expected, this typechecks, because <span class="inlinecode">&gt;</span> shifts the tape <span class="inlinecode">1(1)01</span> right to
    <span class="inlinecode">11(0)1</span>:
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">exec_right_verify</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">E</span> : <span class="id" title="var">Exec</span> (<span class="id" title="var">PRight</span> <span class="id" title="var">PEnd</span>) (<span class="id" title="var">Tape</span> 1 [1] [0; 1])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Tape</span> 0 [1; 1] [1])} := <span class="id" title="var">E</span>.<br/>
<span class="id" title="keyword">Check</span> <span class="id" title="var">exec_right_verify</span>.<br/>

<br/>
</div>

<div class="doc">
However, give it an impossible result and it cannot find an instance:
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">exec_right_bad</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">E</span> : <span class="id" title="var">Exec</span> (<span class="id" title="var">PRight</span> <span class="id" title="var">PEnd</span>) (<span class="id" title="var">Tape</span> 1 [1] [0; 1])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Tape</span> 0 [] [])} := <span class="id" title="var">E</span>.<br/>
<span class="id" title="keyword">Check</span> <span class="id" title="var">exec_right_bad</span>.<br/>

<br/>
</div>

<div class="doc">
More usefully, we can generalize it to any tape <span class="inlinecode"><span class="id" title="var">t</span></span> and let it infer the
    final tape after execution:
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">exec_right</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">E</span> : <span class="id" title="var">Exec</span> (<span class="id" title="var">PRight</span> <span class="id" title="var">PEnd</span>) <span class="id" title="var">t</span>} := <span class="id" title="var">E</span>.<br/>
<span class="id" title="keyword">Check</span> <span class="id" title="var">exec_right</span> (<span class="id" title="var">Tape</span> 1 [1] [0; 1]).<br/>

<br/>
</div>

<div class="doc">
We can execute loops too, like <span class="inlinecode">&gt;*&gt;*[*&lt;]</span>:
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">exec_rr_back</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">E</span> : <span class="id" title="var">Exec</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PLoop</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PLeft</span> <span class="id" title="var">PEnd</span>)) <span class="id" title="var">PEnd</span>))))) <span class="id" title="var">t</span>} := <span class="id" title="var">E</span>.<br/>
<span class="id" title="keyword">Check</span> <span class="id" title="var">exec_rr_back</span> (<span class="id" title="var">Tape</span> 0 [] [1]).<br/>

<br/>
</div>

<div class="doc">
Non-terminating programs like <span class="inlinecode">[]</span> and <span class="inlinecode">&gt;*[&gt;*]</span> work too. For the latter, it
    cannot resolve an instance for any initial tape.

<div class="paragraph"> </div>

    Each iteration of the loop generates for a fresh intermediate value for the
    tape, which ensures a revisited state will not resolve to the same
    instance. When no instance can ever satisfy it, which happens for
    non-terminating programs, the typechecker will infinitely expand the
    constraints and diverge.
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">exec_loop_nonterm</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">E</span> : <span class="id" title="var">Exec</span> (<span class="id" title="var">PLoop</span> <span class="id" title="var">PEnd</span> <span class="id" title="var">PEnd</span>) (<span class="id" title="var">Tape</span> 1 [] [])} := <span class="id" title="var">E</span>.<br/>
<span class="id" title="var">Fail</span> <span class="id" title="var">Timeout</span> 1 <span class="id" title="keyword">Check</span> <span class="id" title="var">exec_loop_nonterm</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">exec_loop_r_nonterm</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">E</span> : <span class="id" title="var">Exec</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PLoop</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> <span class="id" title="var">PEnd</span>)) <span class="id" title="var">PEnd</span>)))} := <span class="id" title="var">E</span>.<br/>
<span class="id" title="var">Fail</span> <span class="id" title="var">Timeout</span> 1 <span class="id" title="keyword">Check</span> <span class="id" title="var">exec_loop_r_nonterm</span>.<br/>

<br/>
</div>

<div class="doc">
And finally, a program that writes “Hallo, Welt!” in binary to the tape,
    <span class="inlinecode">&gt;*&gt;&gt;&gt;*&gt;&gt;&gt;&gt;&gt;*&gt;*&gt;&gt;&gt;&gt;&gt;*&gt;&gt;*&gt;*&gt;&gt;*&gt;*&gt;&gt;&gt;&gt;*&gt;*&gt;&gt;*&gt;*&gt;&gt;&gt;&gt;*&gt;*&gt;&gt;*&gt;*&gt;*&gt;*&gt;&gt;&gt;*&gt;&gt;*&gt;*&gt;&gt;&gt;</span>
    <span class="inlinecode">&gt;&gt;*&gt;&gt;&gt;&gt;&gt;&gt;&gt;*&gt;&gt;*&gt;&gt;*&gt;*&gt;*&gt;&gt;*&gt;*&gt;&gt;&gt;*&gt;&gt;*&gt;&gt;*&gt;*&gt;&gt;*&gt;*&gt;&gt;&gt;&gt;*&gt;*&gt;*&gt;&gt;*&gt;&gt;&gt;&gt;&gt;*&gt;&gt;&gt;&gt;&gt;*&gt;</span>:
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">exec_hworld</span><br/>
&nbsp;&nbsp;`{<span class="id" title="var">E</span> : <span class="id" title="var">Exec</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span> (<span class="id" title="var">PRight</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">PFlip</span> (<span class="id" title="var">PRight</span> <span class="id" title="var">PEnd</span>)))))))))))))))))))))))))))))))))))))))))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))))))))))))))))))))))))))))))))) (<span class="id" title="var">Tape</span> 0 [] [])} := <span class="id" title="var">E</span>.<br/>
<span class="id" title="keyword">Check</span> <span class="id" title="var">exec_hworld</span>.<br/>
<span class="id" title="keyword">Compute</span> <span class="id" title="var">rev</span> <span class="id" title="var">exec_hworld</span>.(<span class="id" title="var">exec</span>).(<span class="id" title="var">ltape</span>).<br/>

<br/>
</div>

<div class="doc">
<a id="lab6"></a><h2 class="section">Conclusion</h2>


<div class="paragraph"> </div>

    To my knowledge, this is the first proof of the Turing-completeness of
    typeclass resolution in Coq.

<div class="paragraph"> </div>

    You can find the source code for this tutorial at
    <a href="https://github.com/thaliaarchi/coq-turing-typeclass">
    github.com/thaliaarchi/coq-turing-typeclass</a>.

<div class="paragraph"> </div>

    For more Turing-complete subsets of programming languages, see my
    compilation <a href="https://github.com/thaliaarchi/notes/blob/main/topics/unexpected_turing.md">
    “Unexpectedly Turing-complete”</a>.

<div class="paragraph"> </div>

    Thanks for reading!
</div>
<div class="code">
</div>
<hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>